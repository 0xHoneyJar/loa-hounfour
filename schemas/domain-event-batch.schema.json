{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://schemas.0xhoneyjar.com/loa-hounfour/2.1.0/domain-event-batch",
  "additionalProperties": false,
  "type": "object",
  "required": [
    "batch_id",
    "correlation_id",
    "events",
    "source",
    "produced_at",
    "contract_version"
  ],
  "properties": {
    "batch_id": {
      "minLength": 1,
      "description": "Unique batch identifier",
      "type": "string"
    },
    "correlation_id": {
      "minLength": 1,
      "description": "Shared correlation across all events in batch",
      "type": "string"
    },
    "events": {
      "minItems": 1,
      "description": "Ordered list of domain events",
      "type": "array",
      "items": {
        "$id": "DomainEvent",
        "additionalProperties": false,
        "type": "object",
        "required": [
          "event_id",
          "aggregate_id",
          "aggregate_type",
          "type",
          "version",
          "occurred_at",
          "actor",
          "payload",
          "contract_version"
        ],
        "properties": {
          "event_id": {
            "minLength": 1,
            "description": "Globally unique event ID",
            "type": "string"
          },
          "aggregate_id": {
            "minLength": 1,
            "description": "ID of the aggregate this event belongs to",
            "type": "string"
          },
          "aggregate_type": {
            "anyOf": [
              {
                "const": "agent",
                "type": "string"
              },
              {
                "const": "conversation",
                "type": "string"
              },
              {
                "const": "billing",
                "type": "string"
              },
              {
                "const": "tool",
                "type": "string"
              },
              {
                "const": "transfer",
                "type": "string"
              },
              {
                "const": "message",
                "type": "string"
              }
            ]
          },
          "type": {
            "pattern": "^[a-z]+\\.[a-z_]+\\.[a-z_]+$",
            "description": "Dotted event type: {aggregate}.{noun}.{verb}",
            "type": "string"
          },
          "version": {
            "minimum": 1,
            "description": "Event schema version",
            "type": "integer"
          },
          "occurred_at": {
            "format": "date-time",
            "type": "string"
          },
          "actor": {
            "minLength": 1,
            "description": "Who/what caused this event",
            "type": "string"
          },
          "correlation_id": {
            "description": "Request correlation chain",
            "type": "string"
          },
          "causation_id": {
            "description": "Direct cause event ID",
            "type": "string"
          },
          "payload": {},
          "contract_version": {
            "pattern": "^\\d+\\.\\d+\\.\\d+$",
            "type": "string"
          },
          "metadata": {
            "description": "Consumer-extensible metadata (not validated by protocol contract)",
            "type": "object",
            "patternProperties": {
              "^(.*)$": {}
            }
          }
        }
      }
    },
    "source": {
      "minLength": 1,
      "description": "System that produced the batch",
      "type": "string"
    },
    "produced_at": {
      "format": "date-time",
      "type": "string"
    },
    "contract_version": {
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "type": "string"
    }
  },
  "$comment": "contract_version=2.1.0, min_supported=2.0.0"
}
