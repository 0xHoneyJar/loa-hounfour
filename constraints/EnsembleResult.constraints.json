{
  "$schema": "https://loa-hounfour.dev/schemas/constraint-file.json",
  "schema_id": "EnsembleResult",
  "contract_version": "5.0.0",
  "expression_version": "1.0",
  "constraints": [
    {
      "id": "ensemble-result-consensus-score",
      "expression": "strategy != 'consensus' || consensus_score != null",
      "severity": "error",
      "message": "consensus_score is required when strategy is 'consensus'",
      "fields": ["strategy", "consensus_score"]
    },
    {
      "id": "ensemble-result-cost-conservation",
      "expression": "selected == null || bigint_gte(total_cost_micro, selected.usage.cost_micro)",
      "severity": "error",
      "message": "total_cost_micro must be >= selected usage cost",
      "fields": ["total_cost_micro", "selected.usage.cost_micro"]
    },
    {
      "id": "ensemble-result-total-cost-equals-sum",
      "expression": "candidates == null || bigint_sum(candidates, 'usage.cost_micro') == total_cost_micro",
      "severity": "error",
      "message": "total_cost_micro must equal sum of all candidate usage costs",
      "fields": ["total_cost_micro", "candidates"]
    },
    {
      "id": "ensemble-result-dialogue-rounds",
      "expression": "strategy != 'dialogue' || (rounds != null && rounds.length > 0)",
      "severity": "error",
      "message": "rounds must be non-empty when strategy is 'dialogue'",
      "fields": ["strategy", "rounds"]
    },
    {
      "id": "ensemble-result-dialogue-termination",
      "expression": "strategy != 'dialogue' || termination_reason != null",
      "severity": "error",
      "message": "termination_reason is required when strategy is 'dialogue'",
      "fields": ["strategy", "termination_reason"]
    }
  ]
}
